{"version":3,"sources":["scify-annotator.js"],"names":[],"mappings":"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","file":"scify-annotator-compiled.js","sourcesContent":["scify.Annotator = function(enableUserToAnnotateSubtext){\n\n    this.enableUserToAnnotateSubtext = enableUserToAnnotateSubtext;\n}\nscify.Annotator.prototype = (function(){\n    var getSelection = function() {\n            if (window.getSelection)\n                return window.getSelection();\n            else if (document.selection)\n                return document.selection;\n\n            return null;\n        },\n        getSelectionText= function(selection){\n            if (window.getSelection)\n                return selection.toString();\n            else if (document.selection)\n                return selection.createRange().text;\n        },\n        getSelectionHtml = function(selection) {\n            var html = \"\";\n            if (window.getSelection) {\n                if (selection.rangeCount) {\n                    var container = document.createElement(\"div\");\n                    for (var i = 0, len = selection.rangeCount; i < len; ++i) {\n                        container.appendChild(selection.getRangeAt(i).cloneContents());\n                    }\n                    html = container.innerHTML;\n                }\n            } else if (document.selection) {\n                if (selection.type == \"Text\")\n                    html = document.selection.createRange().htmlText;\n            }\n            return html;\n        },\n        selectionIsAllowed = function(selection){\n            var html = getSelectionHtml(selection);\n            return html.trim().length>0 && html.indexOf(\"span\")==-1;\n        },\n        clearSelection= function(selection){\n            if(selection){\n                if(selection.empty)\n                    selection.empty();\n\n                if(selection.removeAllRanges)\n                    selection.removeAllRanges();\n            }\n        },\n        attachAnnotationEvents = function(){\n            var instance = this;\n\n            if (instance.enableUserToAnnotateSubtext) {\n                $(\"body\").on(\"mouseup\",\".ann\",function(e){\n                    var selection= getSelection();\n                    if (!selectionIsAllowed(selection)){\n                        clearSelection(selection);\n                        hideToolBar();\n                    }\n                    else\n                        displayToolBar.call(instance,e,getSelectionText(selection));\n                });\n            }\n\n            $(\"body\").on(\"click\",\".ann-icon\",displayToolBar.bind(instance));\n\n        },\n        recurseAllTextNodesAndApply = function(element,action){\n\n            if (element.className && element.className.indexOf(\"skip-ann\")>=0)\n                return;\n\n            if (elementCanBeAnnotated(element))\n            {\n                action(element);\n                return; //dont allow iteration to children\n            }\n\n            if (element.childNodes.length > 0)\n                for (var i = 0; i < element.childNodes.length; i++)\n                {\n                    recurseAllTextNodesAndApply(element.childNodes[i],action);\n                }\n        },\n        elementCanBeAnnotated= function(element) {\n            //an element can be annotated if its a #TEXT node with actual text\n            if (element.nodeType == Node.TEXT_NODE && element.nodeValue.trim() != '')\n                return true;\n\n            //an element can be annotated if all it's children are #TEXT OR SUP nodes\n            var bannedNodeFound=false;\n            for (var i = 0; i < element.childNodes.length; i++) {\n                if ( element.childNodes[i].nodeName !=\"SUP\" &&\n                    element.childNodes[i].nodeName !=\"#text\" &&\n                    element.childNodes[i].nodeName !=\"STRONG\" )\n                {\n                    bannedNodeFound=true; //the child node is not SUP and is not #TEXT node\n                    break;\n                }\n            }\n            if (bannedNodeFound || element.textContent.trim().length==0)\n                return false;\n\n            return true;\n\n        },\n        createAnnotatableAreas = function() {\n            var counter=0;\n            var action = function(element)\n            {\n                if (element.nodeType == Node.TEXT_NODE)\n                    $(element).wrap(\"<span data-id='ann-\"+counter+\"' class='ann'></span>\");\n                else\n                    $(element).html(\"<div data-id='ann-\"+counter+\"' class='ann'>\"+ $(element).html() +\"</div>\");\n\n                counter++;\n            }\n            $(\".article-body,.article-title-text\").each(function(i,el){\n               // discard the br nodes\n               // var html = $(el).html();\n               //  html = html.replace(/<br>/g,\"#brNode#\").replace(/<br\\/>/g,\"#brNode#\");\n               //  $(el).html(html);\n                recurseAllTextNodesAndApply(el,action );\n                //html= $(this).html().replace(/#brNode#/g,\"<br>\");\n                //$(this).html(html);\n            });\n\n        },\n        attachAnnotationPrompts= function(){\n            $(\".ann\").append(\"<span class='ann-icon' title='κλικ εδώ για σχολιασμού όλου του κειμένου'><i class='fa fa-pencil-square-o'></i></span>\");\n            $(\".title\").find(\".ann-icon\").each(function(index){\n                console.log(index);\n                if(index == 0) {\n                    $(this).attr( \"data-step\", \"5\" );\n                    $(this).attr( \"data-intro\", \"Πατώντας επάνω στο μολυβάκι μπορείτε να σχολιάσετε το περιεχόμενο του κειμένου\" );\n                }\n                $(this).attr(\"title\",\"κλικ εδώ για σχολιασμού όλου του άρθρου\");\n            });\n        },\n        fetchTopicTagsForUserSelection = function(selectedText){\n\n            if (selectedText.length>20 &&  $(\"#toolbar\").hasClass(\"logged-in\"))\n            {\n                $.ajax({\n                    method: \"POST\",\n                    url: \"/annotation/extractTags\",\n                    contentType: 'text/plain',\n                    data: selectedText,\n                    success : function(tags){\n                        //add additional tags to the select | these are created based on the text use has selected from the ui\n                        var select =  $('#annotationTagTopicId')\n                        $.each(tags, function (i, tag) {\n                            select.prepend($(\"<option class='text-tag' value='-1'>\"+tag+\"</option>\"));\n                        });\n                        destroyAnnotationTopicTagsSelect();\n                        initAnnotationTopicTagsSelect();\n                    }\n                });\n            }\n        },\n        displayToolBar = function(e,selectedText){\n\n            var target = $(e.target),\n                toolbar = $(\"#toolbar\");\n\n\n            resetForm();\n\n            if (target.hasClass(\"ann-icon\") || target.parent().hasClass(\"ann-icon\")){\n                selectedText =  target.closest(\".ann\").text();\n            }\n\n            var topicsLabel=  $(\"#tag-topics-label\").find(\"span\");\n            var topicsTagTooltip =$(\"#tag-topics-label\").find(\"i\");\n            var problemsLabel = $(\"#tag-problem-label\").find(\"span\");\n\n            if (target.closest(\".title\").length>0)\n            {\n                $(\"#myModalLabel\").text(\"Παρατήρηση/Σχόλιο για όλοκληρο το άρθρο:\");\n                topicsLabel.text(topicsLabel.data(\"article\"));\n                topicsTagTooltip.attr(\"title\",topicsTagTooltip.data(\"article\"));\n                topicsTagTooltip.attr(\"data-original-title\",topicsTagTooltip.data(\"article\"));\n                problemsLabel.text(problemsLabel.data(\"article\"));\n                toolbar.find(\"blockquote\").hide();\n            }\n            else{\n                $(\"#myModalLabel\").text(\"Παρατήρηση/Σχόλιο για το τμήμα κειμένου:\");\n                topicsLabel.text(topicsLabel.data(\"text\"));\n                topicsTagTooltip.attr(\"title\",topicsTagTooltip.data(\"text\"));\n                topicsTagTooltip.attr(\"data-original-title\",topicsTagTooltip.data(\"text\"));\n                problemsLabel.text(problemsLabel.data(\"text\"));\n                toolbar.find(\"blockquote\").show();\n            }\n\n            $(\"#toolbar-modal\").modal(\"show\");\n            fetchTopicTagsForUserSelection(selectedText);\n\n            toolbar.find(\"input[name='annText']\").val(selectedText);\n            var parent = target.closest(\".ann\")\n            var annid=parent.data(\"id\");\n            var articleid=target.closest(\".article\").data(\"id\");\n            toolbar.find(\"input[name='articleid']\").val(articleid);\n            toolbar.find(\"input[name='discussionroomannotationtagid']\").val(annid);\n            toolbar.find(\"blockquote\").text(selectedText);\n\n\n        },\n        collectAnnotatorData = function(e){\n            e.preventDefault();\n            var form = $(\"#toolbar-modal\").find(\"form\");\n            var data = {};\n            form.serializeArray().map(function(x){data[x.name] = x.value;}); //convert to object\n            var extractSelectedTags = function($select){\n                var tags = [];\n                $select.find(\"option:selected\").each(function(index,el){\n                  tags.push({\n                        text :$(el).text(),\n                        value: $(el).attr(\"value\") == $(el).text() ? -1 : $(el).attr(\"value\")\n                    });\n                });\n                return tags;\n            }\n\n            //data.annotationTagText = extractSelectedTags($(\"#annotationTagProblemId\")) //tag text of the problem user selected\n            data.annotationTagProblems = extractSelectedTags($(\"#annotationTagProblemId\")) //tag text of the problem user selected\n            data.annotationTagTopics = extractSelectedTags($(\"#annotationTagTopicId\"));\n\n            data.userAnnotatedText = form.find(\"blockquote\").html();  // the text in the document user annotated\n\n            return data;\n        },\n        hideToolBar = function(){\n            $(\"#toolbar-modal\").modal(\"hide\");\n        },\n        displayAnnotationIcon = function(){\n            var current=$(this).find(\".ann-icon\");\n            current.addClass(\"on\");\n             $(\".ann-icon\").not(current).removeClass(\"on\");\n        },\n        resetForm = function(){\n            if ($(\"#toolbar\").hasClass(\"logged-in\"))\n            {\n                $(\"#annotationTagTopicId\").select2(\"val\",\"\");\n                $(\"#annotationTagTopicId\").find(\".text-tag\").remove(); //remove options related to the user's selected text\n                $(\"#annotationTagProblemId\").select2(\"val\",\"\");\n                $(\"#toolbar\").find(\"textarea\").val(\"\");\n            }\n        },\n        destroyAnnotationTopicTagsSelect = function(){\n            $(\"#annotationTagTopicId\").select2(\"destroy\");\n        },\n        initAnnotationTopicTagsSelect = function(){\n            var firstTag = $(\"#annotationTagTopicId\").find(\"option\").first()\n            var placeHolderExample = firstTag ? \"πχ '\"+ firstTag.text()+\"'\" : \"\";\n            $(\"#annotationTagTopicId\").select2({\n                placeholder:  \"κλικ εδώ για να θέσετε το θέμα \"  + placeHolderExample,\n                tags: true,\n                tokenSeparators: [',', ' ']\n            });\n        },\n        init = function(){\n            createAnnotatableAreas();\n            attachAnnotationPrompts();\n            attachAnnotationEvents();\n\n            $(\"#annotationTagProblemId\").select2({\n                placeholder: \"πχ 'ασάφεια', 'μη κατανοητό κείμενο'\",\n                tags: true,\n                tokenSeparators: [',', ' ']\n            });\n\n            initAnnotationTopicTagsSelect();\n\n            $(\"body\").on(\"mouseenter\",\".ann\",displayAnnotationIcon);\n\n            $(\"body\").on(\"mouseenter\",\".ann-icon\",function(){\n                $(this).parent(\".ann\").toggleClass(\"hl\");\n            });\n\n            $(\"body\").on(\"mouseleave\",\".ann-icon\",function(){\n                $(this).parent(\".ann\").toggleClass(\"hl\");\n            });\n\n        };\n\n    return {\n        init:init,\n        hideToolBar : hideToolBar,\n        collectAnnotatorData : collectAnnotatorData\n    }\n})();\n"]}